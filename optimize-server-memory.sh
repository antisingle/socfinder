#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø–∞–º—è—Ç–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ —Å 1GB RAM

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

echo -e "${YELLOW}üîß –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–∞–º—è—Ç–∏ –¥–ª—è —Å–µ—Ä–≤–µ—Ä–∞ —Å 1GB RAM${NC}"
echo "======================================================"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—â–µ–Ω –ª–∏ —Å–∫—Ä–∏–ø—Ç –æ—Ç root
if [ "$EUID" -ne 0 ]; then
  echo -e "${RED}‚ùå –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω –æ—Ç root!${NC}"
  echo "–í—ã–ø–æ–ª–Ω–∏—Ç–µ: sudo bash $0"
  exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â—É—é –ø–∞–º—è—Ç—å
echo -e "${YELLOW}üìä –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–∞–º—è—Ç–∏:${NC}"
free -h
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–∏–π swap
echo -e "${YELLOW}üìä –¢–µ–∫—É—â–∏–π swap:${NC}"
swapon --show
echo ""

# –°–æ–∑–¥–∞–µ–º swap —Ñ–∞–π–ª —Ä–∞–∑–º–µ—Ä–æ–º 4GB
echo -e "${YELLOW}üíæ –°–æ–∑–¥–∞–µ–º swap —Ñ–∞–π–ª —Ä–∞–∑–º–µ—Ä–æ–º 4GB...${NC}"
if [ -f /swapfile ]; then
  echo -e "${YELLOW}‚ö†Ô∏è Swap —Ñ–∞–π–ª —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –£–¥–∞–ª—è–µ–º –µ–≥–æ...${NC}"
  swapoff /swapfile
  rm -f /swapfile
fi

# –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π swap —Ñ–∞–π–ª
echo -e "${YELLOW}üìù –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π swap —Ñ–∞–π–ª...${NC}"
fallocate -l 4G /swapfile
chmod 600 /swapfile
mkswap /swapfile
swapon /swapfile

# –î–æ–±–∞–≤–ª—è–µ–º swap –≤ fstab –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
if ! grep -q "/swapfile" /etc/fstab; then
  echo -e "${YELLOW}üìù –î–æ–±–∞–≤–ª—è–µ–º swap –≤ /etc/fstab...${NC}"
  echo "/swapfile swap swap defaults 0 0" >> /etc/fstab
fi

# –û–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —è–¥—Ä–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å swap
echo -e "${YELLOW}üîß –û–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —è–¥—Ä–∞...${NC}"

# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º swappiness (–Ω–∞—Å–∫–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω–æ —Å–∏—Å—Ç–µ–º–∞ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å swap)
# –ó–Ω–∞—á–µ–Ω–∏–µ 10 –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ —Å–∏—Å—Ç–µ–º–∞ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å swap —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ RAM –∑–∞–ø–æ–ª–Ω–µ–Ω–∞ –Ω–∞ 90%
sysctl vm.swappiness=10

# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º cache pressure (–Ω–∞—Å–∫–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω–æ —Å–∏—Å—Ç–µ–º–∞ –±—É–¥–µ—Ç –æ—á–∏—â–∞—Ç—å –∫—ç—à)
# –ó–Ω–∞—á–µ–Ω–∏–µ 50 - –±–∞–ª–∞–Ω—Å –º–µ–∂–¥—É –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –ø–∞–º—è—Ç–∏
sysctl vm.vfs_cache_pressure=50

# –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —è–¥—Ä–∞
echo "vm.swappiness=10" >> /etc/sysctl.conf
echo "vm.vfs_cache_pressure=50" >> /etc/sysctl.conf

# –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
sysctl -p

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
echo -e "${YELLOW}üìä –ù–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–∞–º—è—Ç–∏:${NC}"
free -h
echo ""

echo -e "${YELLOW}üìä –ù–æ–≤—ã–π swap:${NC}"
swapon --show
echo ""

echo -e "${GREEN}‚úÖ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–∞–º—è—Ç–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!${NC}"
echo -e "${GREEN}‚úÖ –¢–µ–ø–µ—Ä—å —É –≤–∞—Å –µ—Å—Ç—å 4GB swap —Ñ–∞–π–ª –∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —è–¥—Ä–∞.${NC}"
echo -e "${GREEN}‚úÖ –≠—Ç–æ –¥–æ–ª–∂–Ω–æ –ø–æ–º–æ—á—å —Å –∑–∞–≥—Ä—É–∑–∫–æ–π –±–æ–ª—å—à–æ–≥–æ Excel —Ñ–∞–π–ª–∞.${NC}"
echo ""
echo -e "${YELLOW}üìã –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:${NC}"
echo "1. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ Docker: sudo systemctl restart docker"
echo "2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã: docker-compose -f docker-compose.minimal.yml up -d"
echo "3. –°–ª–µ–¥–∏—Ç–µ –∑–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –ø–∞–º—è—Ç–∏: htop –∏–ª–∏ docker stats"
echo ""
