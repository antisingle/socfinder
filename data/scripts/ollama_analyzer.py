#!/usr/bin/env python3
"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∑–∞—è–≤–æ–∫ –ø—Ä–µ–∑–∏–¥–µ–Ω—Ç—Å–∫–∏—Ö –≥—Ä–∞–Ω—Ç–æ–≤ —á–µ—Ä–µ–∑ ollama API
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç –º–æ–¥–µ–ª—å llama3.1:8b –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º –∏ —Ä–µ—à–µ–Ω–∏–π
"""

import urllib.request
import urllib.parse
import json
import logging
import time
from typing import Dict, List, Optional

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('ollama_analysis.log'),
        logging.StreamHandler()
    ]
)
logger = logging.getLogger(__name__)

class OllamaAnalyzer:
    def __init__(self, model_name: str = "llama3.1:8b", base_url: str = "http://localhost:11434"):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä–∞
        
        Args:
            model_name: –Ω–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏ ollama
            base_url: URL API ollama (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é localhost:11434)
        """
        self.model_name = model_name
        self.base_url = base_url
        self.api_url = f"{base_url}/api/generate"
        
        # –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
        self.system_prompt = """–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∞–Ω–∞–ª–∏–∑—É —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤ –∏ –∑–∞—è–≤–æ–∫ –Ω–∞ –ø—Ä–µ–∑–∏–¥–µ–Ω—Ç—Å–∫–∏–µ –≥—Ä–∞–Ω—Ç—ã. 
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç—ã –∑–∞—è–≤–æ–∫ –∏ –≤—ã—è–≤–ª—è—Ç—å –ö–û–ù–ö–†–ï–¢–ù–´–ï —Å–æ—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º—ã–µ —Ä–µ—à–µ–Ω–∏—è.

## –¢–†–ï–ë–û–í–ê–ù–ò–Ø –ö –û–ü–ò–°–ê–ù–ò–Æ –ü–†–û–ë–õ–ï–ú:
–ö–∞–∂–¥–∞—è –ø—Ä–æ–±–ª–µ–º–∞ –¥–æ–ª–∂–Ω–∞ —Å–æ–¥–µ—Ä–∂–∞—Ç—å:
1. –ö–¢–û —Å—Ç—Ä–∞–¥–∞–µ—Ç (–∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –≥—Ä—É–ø–ø–∞ –ª—é–¥–µ–π: "–ø–µ–Ω—Å–∏–æ–Ω–µ—Ä—ã 60+ –ª–µ—Ç", "–¥–µ—Ç–∏-—Å–∏—Ä–æ—Ç—ã", "–∏–Ω–≤–∞–ª–∏–¥—ã –ø–æ —Å–ª—É—Ö—É")
2. –û–¢ –ß–ï–ì–û —Å—Ç—Ä–∞–¥–∞–µ—Ç (–∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞: "–Ω–µ –∏–º–µ—é—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–ø–æ—Ä—Ç–∏–≤–Ω—ã–º –æ–±—ä–µ–∫—Ç–∞–º", "–Ω–µ –∑–Ω–∞—é—Ç –æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø—Ä–æ–≥—Ä–∞–º–º–∞—Ö")
3. –ì–î–ï –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ: "–≤ —Å–µ–ª—å—Å–∫–∏—Ö —Ä–∞–π–æ–Ω–∞—Ö", "–≤ –≥–æ—Ä–æ–¥–µ –û–º—Å–∫", "–≤ –°–æ–≤–µ—Ç—Å–∫–æ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–æ–º –æ–∫—Ä—É–≥–µ")
4. –ö–ê–ö –ø—Ä–æ—è–≤–ª—è–µ—Ç—Å—è (–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è: "—Ç–æ–ª—å–∫–æ 25% —É—á–∞—Å—Ç–≤—É—é—Ç –≤ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è—Ö", "–Ω–µ—Ç —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ç—Ä–µ–Ω–µ—Ä–æ–≤")

## –¢–†–ï–ë–û–í–ê–ù–ò–Ø –ö –û–ü–ò–°–ê–ù–ò–Æ –†–ï–®–ï–ù–ò–ô:
–ö–∞–∂–¥–æ–µ —Ä–µ—à–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å:
1. –ß–¢–û –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ –¥–µ–ª–∞–µ—Ç—Å—è ("–æ—Ä–≥–∞–Ω–∏–∑—É–µ–º –∑–∏–º–Ω–∏–π —Ñ–µ—Å—Ç–∏–≤–∞–ª—å –∑–¥–æ—Ä–æ–≤—å—è", "—Å—Ç—Ä–æ–∏–º —Å–ø–æ—Ä—Ç–∏–≤–Ω—É—é –ø–ª–æ—â–∞–¥–∫—É")
2. –î–õ–Ø –ö–û–ì–û ("–¥–ª—è –ø–µ–Ω—Å–∏–æ–Ω–µ—Ä–æ–≤ –£–ª—å—è–Ω–æ–≤—Å–∫–æ–π –æ–±–ª–∞—Å—Ç–∏", "–¥–ª—è –¥–µ—Ç–µ–π —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–º–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º–∏")
3. –ì–î–ï —Ä–µ–∞–ª–∏–∑—É–µ—Ç—Å—è ("–≤ 20 –º–µ—Å—Ç–Ω—ã—Ö –æ—Ç–¥–µ–ª–µ–Ω–∏—è—Ö", "–Ω–∞ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏ —à–∫–æ–ª—ã ‚Ññ15")
4. –ö–ê–ö–ò–ï —Ä–µ—Å—É—Ä—Å—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è ("–ø—Ä–∏–≤–ª–µ—á–µ–º 5 —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤", "–∑–∞–∫—É–ø–∏–º —Å–ø–æ—Ä—Ç–∏–≤–Ω—ã–π –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å –Ω–∞ 550,000 —Ä—É–±–ª–µ–π")

## –ü–†–ò–ú–ï–†–´ –•–û–†–û–®–ò–• –û–ü–ò–°–ê–ù–ò–ô:
‚ùå –ü–õ–û–•–û: "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–µ –∏–Ω—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è—Ö"
‚úÖ –•–û–†–û–®–û: "–ü–µ–Ω—Å–∏–æ–Ω–µ—Ä—ã –£–ª—å—è–Ω–æ–≤—Å–∫–æ–π –æ–±–ª–∞—Å—Ç–∏ –Ω–µ –∑–Ω–∞—é—Ç –æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Å–ø–æ—Ä—Ç–∏–≤–Ω—ã—Ö –ø—Ä–æ–≥—Ä–∞–º–º–∞—Ö –∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è—Ö –¥–ª—è –ø–æ–∂–∏–ª—ã—Ö –ª—é–¥–µ–π"

‚ùå –ü–õ–û–•–û: "–£–∫—Ä–µ–ø–ª–µ–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª—å–Ω–æ–π –±–∞–∑—ã"
‚úÖ –•–û–†–û–®–û: "–û—Å–Ω–∞—â–∞–µ–º 20 –∫–ª—É–±–æ–≤ –ø–µ–Ω—Å–∏–æ–Ω–µ—Ä–æ–≤ —Å–ø–æ—Ä—Ç–∏–≤–Ω—ã–º –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ–º –∏ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ–º –¥–ª—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –Ω–∞ –æ–±—â—É—é —Å—É–º–º—É 550,000 —Ä—É–±–ª–µ–π"

–û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–º JSON –≤ —Å–ª–µ–¥—É—é—â–µ–º —Ñ–æ—Ä–º–∞—Ç–µ:
{
  "grant_id": "ID_–∑–∞—è–≤–∫–∏",
  "problems": [
    "–∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –ö–¢–û, –û–¢ –ß–ï–ì–û, –ì–î–ï –∏ –ö–ê–ö —Å—Ç—Ä–∞–¥–∞–µ—Ç"
  ],
  "solutions": [
    "–∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –ß–¢–û, –î–õ–Ø –ö–û–ì–û, –ì–î–ï –∏ –ö–ê–ö–ò–ï —Ä–µ—Å—É—Ä—Å—ã"
  ],
  "summary": "–∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å—É—Ç–∏ –ø—Ä–æ–µ–∫—Ç–∞"
}

–í–ê–ñ–ù–û:
- –ò—Å–ø–æ–ª—å–∑—É–π –¥–≤–æ–π–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏
- –ù–µ –¥–æ–±–∞–≤–ª—è–π –ª–∏—à–Ω–µ–≥–æ —Ç–µ–∫—Å—Ç–∞ –¥–æ –∏–ª–∏ –ø–æ—Å–ª–µ JSON
- –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º/—Ä–µ—à–µ–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ - –∏—Å–ø–æ–ª—å–∑—É–π –ø—É—Å—Ç—ã–µ –º–∞—Å—Å–∏–≤—ã []
- –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–π –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–±–ª–µ–º –∏ —Ä–µ—à–µ–Ω–∏–π –¥–æ 5 —à—Ç—É–∫
- –ö–∞–∂–¥–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Å–∞–º–æ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–º –∏ –ø–æ–Ω—è—Ç–Ω—ã–º –±–µ–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞"""
    
    def test_connection(self) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ ollama API"""
        try:
            req = urllib.request.Request(f"{self.base_url}/api/tags")
            with urllib.request.urlopen(req, timeout=10) as response:
                if response.status == 200:
                    logger.info("‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ ollama API —É—Å–ø–µ—à–Ω–æ")
                    return True
                else:
                    logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ ollama API: {response.status}")
                    return False
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ ollama API: {e}")
            return False
    
    def analyze_grant(self, grant_data: Dict) -> Optional[Dict]:
        """
        –ê–Ω–∞–ª–∏–∑ –æ–¥–Ω–æ–π –∑–∞—è–≤–∫–∏ –Ω–∞ –≥—Ä–∞–Ω—Ç
        
        Args:
            grant_data: —Å–ª–æ–≤–∞—Ä—å —Å –¥–∞–Ω–Ω—ã–º–∏ –≥—Ä–∞–Ω—Ç–∞
            
        Returns:
            –°–ª–æ–≤–∞—Ä—å —Å –∞–Ω–∞–ª–∏–∑–æ–º –∏–ª–∏ None –ø—Ä–∏ –æ—à–∏–±–∫–µ
        """
        try:
            # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
            analysis_text = self._prepare_analysis_text(grant_data)
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç
            user_prompt = f"""–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —ç—Ç—É –∑–∞—è–≤–∫—É –Ω–∞ –ø—Ä–µ–∑–∏–¥–µ–Ω—Ç—Å–∫–∏–π –≥—Ä–∞–Ω—Ç –∏ –≤—ã–¥–µ–ª–∏ —Å–æ—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è.

–î–∞–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏:
{analysis_text}

–û—Ç–≤–µ—á–∞–π —Ç–æ–ª—å–∫–æ –≤–∞–ª–∏–¥–Ω—ã–º JSON –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞."""

            # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
            payload = {
                "model": self.model_name,
                "prompt": user_prompt,
                "system": self.system_prompt,
                "stream": False,
                "options": {
                    "temperature": 0.3,
                    "top_p": 0.9,
                    "max_tokens": 1000
                }
            }
            
            logger.info(f"–û—Ç–ø—Ä–∞–≤–ª—è—é –∑–∞–ø—Ä–æ—Å –∫ –º–æ–¥–µ–ª–∏ {self.model_name}...")
            start_time = time.time()
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ ollama
            data = json.dumps(payload).encode('utf-8')
            req = urllib.request.Request(
                self.api_url,
                data=data,
                headers={'Content-Type': 'application/json'}
            )
            
            with urllib.request.urlopen(req, timeout=120) as response:
                if response.status != 200:
                    logger.error(f"‚ùå –û—à–∏–±–∫–∞ API ollama: {response.status}")
                    return None
                
                # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç
                response_data = response.read().decode('utf-8')
                result = json.loads(response_data)
                response_text = result.get('response', '')
            
            processing_time = time.time() - start_time
            logger.info(f"‚úÖ –û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω –∑–∞ {processing_time:.2f} —Å–µ–∫")
            
            # –ü–∞—Ä—Å–∏–º JSON –æ—Ç–≤–µ—Ç
            try:
                analysis = json.loads(response_text.strip())
                logger.info(f"‚úÖ JSON —É—Å–ø–µ—à–Ω–æ —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω: {len(analysis.get('problems', []))} –ø—Ä–æ–±–ª–µ–º, {len(analysis.get('solutions', []))} —Ä–µ—à–µ–Ω–∏–π")
                return analysis
                
            except json.JSONDecodeError as e:
                logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON: {e}")
                logger.error(f"–ü–æ–ª—É—á–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç: {response_text[:200]}...")
                return None
                
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –≥—Ä–∞–Ω—Ç–∞: {e}")
            return None
    
    def _prepare_analysis_text(self, grant_data: Dict) -> str:
        """–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞"""
        fields = [
            ('–ù–∞–∑–≤–∞–Ω–∏–µ', grant_data.get('name', '')),
            ('–û–ø–∏—Å–∞–Ω–∏–µ', grant_data.get('description', '')),
            ('–¶–µ–ª–∏', grant_data.get('goal', '')),
            ('–ó–∞–¥–∞—á–∏', grant_data.get('tasks', '')),
            ('–°–æ—Ü–∏–∞–ª—å–Ω–∞—è –∑–Ω–∞—á–∏–º–æ—Å—Ç—å', grant_data.get('soc_signif', '')),
            ('–ì–µ–æ–≥—Ä–∞—Ñ–∏—è', grant_data.get('pj_geo', '')),
            ('–¶–µ–ª–µ–≤—ã–µ –≥—Ä—É–ø–ø—ã', grant_data.get('target_groups', ''))
        ]
        
        text_parts = []
        for label, value in fields:
            if value and str(value).strip():
                text_parts.append(f"{label}: {value}")
        
        return "\n\n".join(text_parts)
    
    def batch_analyze(self, grants_data: List[Dict], batch_size: int = 5) -> List[Dict]:
        """
        –ü–∞–∫–µ—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –≥—Ä–∞–Ω—Ç–æ–≤
        
        Args:
            grants_data: —Å–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π —Å –¥–∞–Ω–Ω—ã–º–∏ –≥—Ä–∞–Ω—Ç–æ–≤
            batch_size: —Ä–∞–∑–º–µ—Ä –ø–∞–∫–µ—Ç–∞
            
        Returns:
            –°–ø–∏—Å–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∞–Ω–∞–ª–∏–∑–∞
        """
        results = []
        total_grants = len(grants_data)
        
        logger.info(f"üöÄ –ù–∞—á–∏–Ω–∞—é –ø–∞–∫–µ—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑ {total_grants} –≥—Ä–∞–Ω—Ç–æ–≤ (–ø–∞–∫–µ—Ç: {batch_size})")
        
        for i in range(0, total_grants, batch_size):
            batch = grants_data[i:i + batch_size]
            batch_num = i // batch_size + 1
            total_batches = (total_grants + batch_size - 1) // batch_size
            
            logger.info(f"üì¶ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é –ø–∞–∫–µ—Ç {batch_num}/{total_batches} ({len(batch)} –≥—Ä–∞–Ω—Ç–æ–≤)")
            
            for j, grant_data in enumerate(batch):
                grant_num = i + j + 1
                logger.info(f"  üìã –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –≥—Ä–∞–Ω—Ç {grant_num}/{total_grants}: {grant_data.get('name', 'N/A')[:50]}...")
                
                analysis = self.analyze_grant(grant_data)
                if analysis:
                    # –î–æ–±–∞–≤–ª—è–µ–º ID –≥—Ä–∞–Ω—Ç–∞ –∏–∑ –∏—Å—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                    analysis['grant_id'] = grant_data.get('req_num', f'grant_{grant_num}')
                    results.append(analysis)
                    logger.info(f"    ‚úÖ –£—Å–ø–µ—à–Ω–æ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
                else:
                    logger.warning(f"    ‚ö†Ô∏è –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –≥—Ä–∞–Ω—Ç–∞ {grant_num}")
                
                # –ù–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
                time.sleep(1)
            
            logger.info(f"üì¶ –ü–∞–∫–µ—Ç {batch_num} –∑–∞–≤–µ—Ä—à–µ–Ω. –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: {len(results)}/{total_grants}")
        
        logger.info(f"üéâ –ü–∞–∫–µ—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω! –£—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ: {len(results)}/{total_grants}")
        return results

def main():
    """–¢–µ—Å—Ç–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è"""
    analyzer = OllamaAnalyzer()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
    if not analyzer.test_connection():
        logger.error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ ollama API")
        return
    
    # –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
    test_grant = {
        'req_num': 'TEST-001',
        'name': '–¢–µ—Å—Ç–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç',
        'description': '–ü—Ä–æ–µ–∫—Ç –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ —Ä–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º –ø–æ–∂–∏–ª—ã—Ö –ª—é–¥–µ–π',
        'goal': '–ü–æ–≤—ã—à–µ–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞ –∂–∏–∑–Ω–∏ –ø–æ–∂–∏–ª—ã—Ö –ª—é–¥–µ–π',
        'tasks': '–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π, —Å–æ–∑–¥–∞–Ω–∏–µ –∫–ª—É–±–æ–≤',
        'soc_signif': '–°–æ—Ü–∏–∞–ª—å–Ω–∞—è –∏–∑–æ–ª—è—Ü–∏—è –ø–æ–∂–∏–ª—ã—Ö –ª—é–¥–µ–π',
        'pj_geo': '–ú–æ—Å–∫–≤–∞',
        'target_groups': '–ü–æ–∂–∏–ª—ã–µ –ª—é–¥–∏ 60+ –ª–µ—Ç'
    }
    
    logger.info("üß™ –¢–µ—Å—Ç–∏—Ä—É—é –∞–Ω–∞–ª–∏–∑ –Ω–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö...")
    result = analyzer.analyze_grant(test_grant)
    
    if result:
        logger.info("‚úÖ –¢–µ—Å—Ç —É—Å–ø–µ—à–µ–Ω!")
        logger.info(f"–†–µ–∑—É–ª—å—Ç–∞—Ç: {json.dumps(result, ensure_ascii=False, indent=2)}")
    else:
        logger.error("‚ùå –¢–µ—Å—Ç –Ω–µ –ø—Ä–æ—à–µ–ª")

if __name__ == "__main__":
    main()
